# Comparing `tmp/pygbase8s-1.2.0-py3-none-any.whl.zip` & `tmp/pygbase8s-1.3.0-py3-none-any.whl.zip`

## zipinfo {}

```diff
@@ -1,21 +1,22 @@
-Zip file size: 24645 bytes, number of entries: 19
--rw-rw-rw-  2.0 fat      490 b- defN 24-Mar-14 11:42 pygbase8s/__init__.py
--rw-rw-rw-  2.0 fat     7516 b- defN 24-Mar-31 11:36 pygbase8s/cluster.py
--rw-rw-rw-  2.0 fat     4103 b- defN 24-Mar-31 11:36 pygbase8s/cm.py
+Zip file size: 26451 bytes, number of entries: 20
+-rw-rw-rw-  2.0 fat      499 b- defN 24-Apr-20 14:02 pygbase8s/__init__.py
+-rw-rw-rw-  2.0 fat     8599 b- defN 24-Apr-20 14:02 pygbase8s/cluster.py
+-rw-rw-rw-  2.0 fat     4073 b- defN 24-Apr-20 14:02 pygbase8s/cm.py
 -rw-rw-rw-  2.0 fat     1063 b- defN 24-Mar-14 11:05 pygbase8s/dblog.py
 -rw-rw-rw-  2.0 fat     6723 b- defN 24-Mar-31 11:36 pygbase8s/dbspace.py
+-rw-rw-rw-  2.0 fat     1382 b- defN 24-Apr-20 14:02 pygbase8s/driver_manager.py
 -rw-rw-rw-  2.0 fat     1722 b- defN 24-Mar-12 13:04 pygbase8s/env.py
 -rw-rw-rw-  2.0 fat     2272 b- defN 24-Mar-31 11:36 pygbase8s/instance.py
--rw-rw-rw-  2.0 fat     7292 b- defN 24-Mar-31 11:36 pygbase8s/machine.py
--rw-rw-rw-  2.0 fat     6775 b- defN 24-Mar-31 11:36 pygbase8s/onconfig.py
+-rw-rw-rw-  2.0 fat     7425 b- defN 24-Apr-20 14:02 pygbase8s/machine.py
+-rw-rw-rw-  2.0 fat     6776 b- defN 24-Apr-20 14:02 pygbase8s/onconfig.py
 -rw-rw-rw-  2.0 fat     3459 b- defN 24-Mar-14 11:05 pygbase8s/product.py
--rw-rw-rw-  2.0 fat    17651 b- defN 24-Mar-31 11:36 pygbase8s/server.py
+-rw-rw-rw-  2.0 fat    17747 b- defN 24-Apr-20 14:02 pygbase8s/server.py
 -rw-rw-rw-  2.0 fat     4587 b- defN 24-Mar-31 11:36 pygbase8s/server_pool.py
 -rw-rw-rw-  2.0 fat     5730 b- defN 24-Mar-31 11:36 pygbase8s/sqlhosts.py
--rw-rw-rw-  2.0 fat     5580 b- defN 24-Mar-31 11:36 pygbase8s/ssh_session.py
--rw-rw-rw-  2.0 fat     1086 b- defN 24-Mar-31 11:45 pygbase8s-1.2.0.dist-info/LICENSE
--rw-rw-rw-  2.0 fat     1775 b- defN 24-Mar-31 11:45 pygbase8s-1.2.0.dist-info/METADATA
--rw-rw-rw-  2.0 fat       92 b- defN 24-Mar-31 11:45 pygbase8s-1.2.0.dist-info/WHEEL
--rw-rw-rw-  2.0 fat       10 b- defN 24-Mar-31 11:45 pygbase8s-1.2.0.dist-info/top_level.txt
-?rw-rw-r--  2.0 fat     1474 b- defN 24-Mar-31 11:45 pygbase8s-1.2.0.dist-info/RECORD
-19 files, 79400 bytes uncompressed, 22281 bytes compressed:  71.9%
+-rw-rw-rw-  2.0 fat     5631 b- defN 24-Apr-20 14:02 pygbase8s/ssh_session.py
+-rw-rw-rw-  2.0 fat     1086 b- defN 24-Apr-20 14:10 pygbase8s-1.3.0.dist-info/LICENSE
+-rw-rw-rw-  2.0 fat     2615 b- defN 24-Apr-20 14:10 pygbase8s-1.3.0.dist-info/METADATA
+-rw-rw-rw-  2.0 fat       92 b- defN 24-Apr-20 14:10 pygbase8s-1.3.0.dist-info/WHEEL
+-rw-rw-rw-  2.0 fat       10 b- defN 24-Apr-20 14:10 pygbase8s-1.3.0.dist-info/top_level.txt
+?rw-rw-r--  2.0 fat     1558 b- defN 24-Apr-20 14:10 pygbase8s-1.3.0.dist-info/RECORD
+20 files, 83049 bytes uncompressed, 23957 bytes compressed:  71.2%
```

## zipnote {}

```diff
@@ -9,14 +9,17 @@
 
 Filename: pygbase8s/dblog.py
 Comment: 
 
 Filename: pygbase8s/dbspace.py
 Comment: 
 
+Filename: pygbase8s/driver_manager.py
+Comment: 
+
 Filename: pygbase8s/env.py
 Comment: 
 
 Filename: pygbase8s/instance.py
 Comment: 
 
 Filename: pygbase8s/machine.py
@@ -36,23 +39,23 @@
 
 Filename: pygbase8s/sqlhosts.py
 Comment: 
 
 Filename: pygbase8s/ssh_session.py
 Comment: 
 
-Filename: pygbase8s-1.2.0.dist-info/LICENSE
+Filename: pygbase8s-1.3.0.dist-info/LICENSE
 Comment: 
 
-Filename: pygbase8s-1.2.0.dist-info/METADATA
+Filename: pygbase8s-1.3.0.dist-info/METADATA
 Comment: 
 
-Filename: pygbase8s-1.2.0.dist-info/WHEEL
+Filename: pygbase8s-1.3.0.dist-info/WHEEL
 Comment: 
 
-Filename: pygbase8s-1.2.0.dist-info/top_level.txt
+Filename: pygbase8s-1.3.0.dist-info/top_level.txt
 Comment: 
 
-Filename: pygbase8s-1.2.0.dist-info/RECORD
+Filename: pygbase8s-1.3.0.dist-info/RECORD
 Comment: 
 
 Zip file comment:
```

## pygbase8s/__init__.py

```diff
@@ -5,23 +5,23 @@
 from .product import *
 from .server_pool import *
 from .server import *
 from .cm import *
 from .cluster import *
 from .onconfig import *
 from .sqlhosts import *
+from .driver_manager import *
 
 
 __all__ = [
     'RemoteMachine',
     'User',
     'IDS',
     'CSDK',
     'ServerPool',
     'Server',
     'CM',
-    'SDSCluster',
-    'HDRCluster',
-    'RSSCluster',
+    'Cluster',
     'ServerOnconfig',
-    'ServerSQLHosts'
+    'ServerSQLHosts',
+    'JDBCDriver'
 ]
```

## pygbase8s/cluster.py

```diff
@@ -1,182 +1,216 @@
 # coding: utf-8
 # @Time    : 2024/3/5 10:01
 # @Author  : wangwei
-from abc import ABCMeta, abstractmethod
 from pygbase8s.server import Server
 
 
-class Cluster(metaclass=ABCMeta):
+class Cluster:
     """
-    GBase 8s集群抽象类
+    具备搭建HDR\RSS\SDS 以及两地三中心的能力
     """
 
-    def __init__(self, primary_node: Server, slave_node: Server):
-        """
-        :param primary_node: SERVER, 主节点
-        :param slave_node: SERVER, 备节点
-        """
+    def __init__(self, primary_node: Server):
         self._primary_node = primary_node
-        self._slave_node = slave_node
-
-    @abstractmethod
-    def initialize(self):
-        """
-        集群初始化
-        :return:
-        """
-        pass
+        self._hdr_node = None
+        self._sds_nodes = list()
+        self._rss_nodes = list()
+        self._remote_level0_path = '/tmp/tape_L0'
+        self._local_level0_path = 'tape_L0'
+        self._new_level0 = True
+        self._is_start = False
 
     @property
-    def primary_node(self):
-        """
-        返回集群的主节点
-        :return: SERVER
-        """
-        return self._primary_node
+    def new_level0(self) -> bool:
+        return self._new_level0
 
+    @new_level0.setter
+    def new_level0(self, value: bool):
+        self._new_level0 = value
 
     @property
-    def slave_node(self):
-        """
-        返回集群的备节点
-        :return: SERVER
-        """
-        return self._slave_node
-
-    def release(self):
-        """
-        释放集群
-        :return:
-        """
-        self.primary_node.release()
-        self.slave_node.release()
-
-    def set_trust(self):
-        """
-        配置互信
-        :return:
-        """
-        self.primary_node.ids.machine.trust(self.slave_node.ids.machine)
-
-
-class SDSCluster(Cluster):
-    """
-    SDS集群类
-    """
-    type = 'SDS'
+    def remote_level0_path(self):
+        return self._remote_level0_path
 
-    def initialize(self):
-        """
-        初始化SDS集群
-        :return:
-        """
-        if self.primary_node.ip != self.slave_node.ip:
-            self.set_trust()
-        self.slave_node.onconfig.set_variable('SDS_ENABLE', '1')
-        self.slave_node.onconfig.set_variable('SDS_PAGING', '{0}/sdstmp1,{0}/sdstmp2'.format(self.slave_node.path))
-        self.slave_node.onconfig.set_variable('SDS_TEMPDBS',
-                                            f'sdstmpdbs1, {self.slave_node.path}/sdstmpdbs1,2,0,16000')
-        code, out = self.slave_node.run_cmd(f"mkdir -p {self.slave_node.path};chmod 755 {self.slave_node.path}")
-        if code != 0:
-            raise Exception(f"备节点创建存储目录失败，错误码{code}, 错误信息{out}")
-        code, out = self.slave_node.run_cmd(f'cd {self.slave_node.path}; touch sdstmp1 sdstmp2;chown gbasedbt:gbasedbt sdstmp1 sdstmp2;'
-                              f' chmod 660 sdstmp1 sdstmp2')
-        if code != 0:
-            raise Exception(f"备节点创建sdstmp失败，错误码{code}, 错误信息{out}")
-        code, out = self.slave_node.run_cmd(
-            f'cd {self.slave_node.path}; touch sdstmpdbs1;chown gbasedbt:gbasedbt sdstmpdbs1; chmod 660 sdstmpdbs1')
-        if code != 0:
-            raise Exception(f"备节点创建sdstmpdbs失败，错误码{code}, 错误信息{out}")
-
-        self.primary_node.sqlhosts.add_server(self.slave_node.name, self.slave_node.ip, self.slave_node.port)
-        self.slave_node.sqlhosts.add_server(self.primary_node.name, self.primary_node.ip, self.primary_node.port)
-        self.primary_node.initialize()
-        code, out = self.primary_node.run_cmd(f'onmode -d set SDS primary {self.primary_node.name}')
-        if code != 0:
-            raise Exception(f"主节点set SDS primary 失败，错误码{code}, 错误信息{out}")
-        if self.primary_node.ip == self.slave_node.ip:
-            self.slave_node.path = self.primary_node.path
-        self.slave_node.startup()
+    @remote_level0_path.setter
+    def remote_level0_path(self, path):
+        self._remote_level0_path = path
 
+    @property
+    def local_level0_path(self):
+        return self._local_level0_path
 
-class HDRCluster(Cluster):
-    """
-    HDR集群类
-    """
-    type = 'HDR'
-
-    def initialize(self):
-        """
-        初始化HDR集群
-        :return:
-        """
-        if self.primary_node.ip != self.slave_node.ip:
-            self.set_trust()
-        for node in [self.primary_node, self.slave_node]:
-            node.onconfig.set_variable('DRAUTO', '3')
-            node.onconfig.set_variable('DRINTERVAL', '30')
-            node.onconfig.set_variable('DRTIMEOUT', '30')
-            node.onconfig.set_variable('HA_FOC_ORDER', 'HDR')
-            node.onconfig.set_variable('UPDATABLE_SECONDARY', '0')
-            node.onconfig.set_variable('DRLOSTFOUND', '$GBASEDBTDIR/etc/dr.lostfound')
-        self.primary_node.sqlhosts.add_server(self.slave_node.name, self.slave_node.ip, self.slave_node.port)
-        self.slave_node.sqlhosts.add_server(self.primary_node.name, self.primary_node.ip, self.primary_node.port)
-        self.primary_node.initialize()
-        code, out = self.primary_node.run_cmd(f'onmode -d primary {self.slave_node.name}')
-        if code != 0:
-            raise Exception(f"主节点执行onmode -d primary失败，错误码{code}, 错误信息{out}")
-        # 主做0及备份
-        code ,out = self.primary_node.run_cmd(f'ontape -s -L 0 -t STDIO > /tmp/tape_L0', cwd=self.primary_node.path)
-        if code != 0:
-            raise Exception(f"主节点执行0级备份失败，错误码{code}, 错误信息{out}")
-        if self.primary_node.ip != self.slave_node.ip:
-            self.primary_node.ids.machine.download('/tmp/tape_L0', 'tape_L0')
-            self.slave_node.ids.machine.upload('tape_L0', '/tmp/tape_L0')
-        # 备做备份恢复
-        self.slave_node._add_chunk_file('rootdbs')
-        code, out = self.slave_node.run_cmd('cat /tmp/tape_L0|ontape -p -t STDIO', cwd=self.slave_node.path)
-        if code != 0:
-            raise Exception(f"备节点执行备份恢复失败，错误码{code}, 错误信息{out}")
-        code, out = self.slave_node.run_cmd(f'onmode -d secondary {self.primary_node.name}')
-        if code != 0:
-            raise Exception(f"备节点执行onmode -d secondary失败，错误码{code}, 错误信息{out}")
+    @local_level0_path.setter
+    def local_level0_path(self, path):
+        self._local_level0_path = path
 
+    @property
+    def primary_node(self):
+        return self._primary_node
 
-class RSSCluster(Cluster):
-    """
-    RSS集群类
-    """
-    type='RSS'
+    @property
+    def hdr_node(self):
+        return self._hdr_node
 
-    def initialize(self):
-        """
-        初始化RSS集群
-        :return:
-        """
-        if self.primary_node.ip != self.slave_node.ip:
-            self.set_trust()
-        self.primary_node.onconfig.set_variable('LOG_INDEX_BUILDS', '1')
-        self.primary_node.sqlhosts.add_server(self.slave_node.name, self.slave_node.ip, self.slave_node.port)
-        self.slave_node.sqlhosts.add_server(self.primary_node.name, self.primary_node.ip, self.primary_node.port)
-        self.primary_node.initialize()
-        code, out = self.primary_node.run_cmd(f'onmode -d add RSS {self.slave_node.name}')
-        if code != 0:
-            raise Exception(f"主节点执行onmode -d add RSS失败，错误码{code}, 错误信息{out}")
-        # 主做0及备份
-        code, out = self.primary_node.run_cmd(f'ontape -s -L 0 -t STDIO > /tmp/tape_L0', cwd=self.primary_node.path)
-        if code != 0:
-            raise Exception(f"主节点执行0级备份失败，错误码{code}, 错误信息{out}")
-        if self.primary_node.ip != self.slave_node.ip:
-            self.primary_node.ids.machine.download('/tmp/tape_L0', 'tape_L0')
-            self.slave_node.ids.machine.upload('tape_L0', '/tmp/tape_L0')
-        # 备做备份恢复
-        self.slave_node._add_chunk_file('rootdbs')
-        code, out = self.slave_node.run_cmd('cat /tmp/tape_L0|ontape -p -t STDIO', cwd=self.slave_node.path)
-        if code != 0:
-            raise Exception(f"备节点执行备份恢复失败，错误码{code}, 错误信息{out}")
-        code, out = self.slave_node.run_cmd(f'onmode -d RSS {self.primary_node.name}')
-        if code != 0:
-            raise Exception(f"备节点执行onmode -d RSS失败，错误码{code}, 错误信息{out}")
+    @hdr_node.setter
+    def hdr_node(self, hdr: Server):
+        self.primary_node.ids.machine.trust(hdr.ids.machine)
+        self._hdr_node = hdr
+        if self._is_start:
+            self.hdr_init()
 
+    @property
+    def sds_nodes(self):
+        return self._sds_nodes
 
+    @property
+    def rss_nodes(self):
+        return self._rss_nodes
 
+    def add_sds(self, sds: Server):
+        self.primary_node.ids.machine.trust(sds.ids.machine)
+        self._sds_nodes.append(sds)
+        if self._is_start:
+            self.default_sqlhosts_init()
+            self._params_common(sds)
+            self.sds_init(sds, is_primary=False)
+
+    def add_rss(self, rss: Server):
+        self.primary_node.ids.machine.trust(rss.ids.machine)
+        self._rss_nodes.append(rss)
+        if self._is_start:
+            self.default_sqlhosts_init()
+            self._params_common(rss)
+            if len(self.rss_nodes) == 1:
+                self.primary_node.run_cmd("onmode -wf LOG_INDEX_BUILDS=1")
+            self.rss_init(rss)
+
+    def remove_rss(self, rss: Server):
+        self.primary_node.run_cmd(f"onmode -d delete RSS {rss.name}")
+
+    def get_all_slaves(self):
+        slaves = []
+        slaves.extend(self.sds_nodes)
+        slaves.extend(self.rss_nodes)
+        if self.hdr_node:
+            slaves.append(self.hdr_node)
+        return slaves
+
+    @staticmethod
+    def _params_common(node: Server):
+        node.onconfig.set_variable('DRINTERVAL', '30')
+        node.onconfig.set_variable('DRTIMEOUT', '30')
+        node.onconfig.set_variable('UPDATABLE_SECONDARY', '0')
+        node.onconfig.set_variable('DRLOSTFOUND', '$GBASEDBTDIR/etc/dr.lostfound')
+
+    def sds_init(self, node: Server, is_primary: False):
+        tmp_path = f'{node.path}_tmp'
+        if not is_primary:
+            node.onconfig.set_variable('SDS_ENABLED', '1')
+        node.onconfig.set_variable('SDS_PAGING', f'{tmp_path}/sdstmp1,{tmp_path}/sdstmp2')
+        node.onconfig.set_variable('SDS_TEMPDBS', f'sdstmpdbs1, {tmp_path}_tmp/sdstmpdbs1,2,0,16000')
+        self._sds_add_tmp(node, tmp_path)
+        if not is_primary:
+            if node.ip == self.primary_node.ip:
+                node.path = self.primary_node.path
+            node.startup()
+        else:
+            node.initialize()
+            code, out = node.run_cmd(f'onmode -d set SDS primary {node.name}')
+            if code != 0:
+                raise Exception(f"主节点{node.name} set SDS primary {node.name}失败，错误码{code}, 错误信息{out}")
+
+    @staticmethod
+    def _sds_add_tmp(node: Server, tmp_path: str):
+        code, out = node.run_cmd(f"mkdir -p {node.path} {tmp_path};chmod 755 {node.path} {tmp_path}")
+        if code != 0:
+            raise Exception(f"节点{node.name}创建存储目录失败，错误码{code}, 错误信息{out}")
+        code, out = node.run_cmd(
+            'touch sdstmp1 sdstmp2;chown gbasedbt:gbasedbt sdstmp1 sdstmp2;chmod 660 sdstmp1 sdstmp2',
+            cwd=f'{tmp_path}')
+        if code != 0:
+            raise Exception(f"节点{node.name}创建sdstmp失败，错误码{code}, 错误信息{out}")
+        code, out = node.run_cmd('touch sdstmpdbs1;chown gbasedbt:gbasedbt sdstmpdbs1; chmod 660 sdstmpdbs1',
+                                 cwd=f'{tmp_path}')
+        if code != 0:
+            raise Exception(f"节点{node.name}创建sdstmpdbs失败，错误码{code}, 错误信息{out}")
+
+    def default_onconfig_init(self):
+        nodes = self.get_all_slaves()
+        nodes.insert(1, self.primary_node)
+        for node in nodes:
+            self._params_common(node)
+
+    def default_sqlhosts_init(self):
+        slaves = self.get_all_slaves()
+        slaves.insert(0, self.primary_node)
+        for node in slaves:
+            other_nodes = [_node for _node in slaves if _node != node]
+            for _node in other_nodes:
+                node.sqlhosts.add_server(_node.name, _node.ip, _node.port)
+
+    def backup_restore(self, node_backup: Server, node_restore: Server, strage='FILE'):
+        if strage == 'FILE':
+            self._backup_restore_with_file(node_backup, node_restore)
+        else:
+            raise Exception(f"not support the strage <{strage}>")
+
+    def _backup_restore_with_file(self, node_backup: Server, node_restore: Server):
+        self._get_backup_file(node_backup)
+        node_restore.ids.machine.upload(self.local_level0_path, self.remote_level0_path)
+        self._restore_with_file(node_restore, self.remote_level0_path)
+
+    def _get_backup_file(self, node: Server):
+        if self.new_level0:
+            code, out = node.run_cmd(f"ontape -s -L 0 -t STDIO > {self.remote_level0_path}")
+            if code != 0:
+                raise Exception(f"节点{node.name}执行0级备份失败，错误码{code}, 错误信息{out}")
+            node.ids.machine.download(self.remote_level0_path, self.local_level0_path)
+            self.new_level0 = False
+
+    def _restore_with_file(self, node, file):
+        code, out = node.run_cmd(f'cat {file}|ontape -p -t STDIO', cwd=node.path)
+        if code != 0:
+            raise Exception(f"节点{node.name}执行备份恢复失败，错误码{code}, 错误信息{out}")
+
+    def hdr_init(self):
+        code, out = self.primary_node.run_cmd(f'onmode -d primary {self.hdr_node.name}')
+        if code != 0:
+            raise Exception(
+                f"节点{self.primary_node.name}执行onmode -d primary {self.hdr_node.name}失败，错误码{code}, 错误信息{out}")
+        self.hdr_node._add_chunk_file('rootdbs')
+        self.backup_restore(self.primary_node, self.hdr_node)
+        code, out = self.hdr_node.run_cmd(f'onmode -d secondary {self.primary_node.name}')
+        if code != 0:
+            raise Exception(
+                f"节点{self.hdr_node.name}执行onmode -d secondary失败，错误码{code}, 错误信息{out}")
+
+    def rss_init(self, rss: Server):
+        code, out = self.primary_node.run_cmd(f'onmode -d add RSS {rss.name}')
+        if code != 0:
+            raise Exception(
+                f"节点{self.primary_node.name}执行onmode -d add RSS {rss.name}失败，错误码{code}, 错误信息{out}")
+        rss._add_chunk_file('rootdbs')
+        self.backup_restore(self.primary_node, rss)
+        code, out = rss.run_cmd(f'onmode -d RSS {self.primary_node.name}')
+        if code != 0:
+            raise Exception(f"节点{rss.name}执行onmode -d RSS {self.primary_node.name}失败，错误码{code}, 错误信息{out}")
+
+    def startup(self):
+        self._is_start = True
+        if len(self.sds_nodes) > 0:
+            self.sds_init(self.primary_node, is_primary=True)
+            for node in self.sds_nodes:
+                self.sds_init(node, is_primary=False)
+        else:
+            self.primary_node.initialize()
+        if len(self.rss_nodes) > 0:
+            self.primary_node.run_cmd('onmode -wf LOG_INDEX_BUILDS=1')
+            for node in self.rss_nodes:
+                self.rss_init(node)
+        if self.hdr_node:
+            self.hdr_init()
+
+    def shutdown(self):
+        for slave in self.get_all_slaves():
+            slave.shutdown()
+        self.primary_node.shutdown()
```

## pygbase8s/cm.py

```diff
@@ -24,15 +24,15 @@
         self._product = self.csdk
         self._cluster = cluster
         if not port:
             self._port = self.csdk.machine.get_available_server_port()
         else:
             self._port = port
         if not name:
-            self._name = f"{self.cluster.primary_node.name}_{self.cluster.slave_node.name}"
+            self._name = "single_cm"
         else:
             self._name = name
         self._sqlhosts = None
         self._onconfig = None
         self._path = self.csdk.path
         self._env = ENV()
         self._env.set_variable('GBASEDBTDIR', self.csdk.path)
@@ -55,30 +55,31 @@
         :return: CM的onconfig实例
         """
         if not self._onconfig:
             self._onconfig = CMOnconfig(self.csdk, self.name)
             self._onconfig.initialize()
             cluster_info = f'''
             GBASEDBTSERVER db_group
-            SLA {self.name} DBSERVERS=PRI+{self.cluster.type.upper()} WORKERS=16
+            SLA {self.name} DBSERVERS=ALL WORKERS=16
             FOC ORDER=ENABLED TIMEOUT=10 RETRY=1 PRIORITY=1'''
             self._onconfig.add_cluster_info(cluster_info)
         return self._onconfig
 
     @property
     def sqlhosts(self):
         """
         :return: CM的sqlhosts实例
         """
         if not self._sqlhosts:
             self._sqlhosts = CMSQLHosts(self.csdk, self.name)
             self._sqlhosts.initialize()
             self._sqlhosts.add_group(group_name='db_group', i=10, c=1)
             self._sqlhosts.add_server_to_group(self.cluster.primary_node, 'db_group')
-            self._sqlhosts.add_server_to_group(self.cluster.slave_node, 'db_group')
+            for slave_node in self.cluster.get_all_slaves():
+                self._sqlhosts.add_server_to_group(slave_node, 'db_group')
             self._sqlhosts.add_group(group_name='cm', i=12, c=0)
             self._sqlhosts.add_server_to_group(self, 'cm')
         return self._sqlhosts
 
     @property
     def cluster(self):
         """
```

## pygbase8s/machine.py

```diff
@@ -65,23 +65,25 @@
             }
             self._server_num_min = server_num_min
             self._port_min = port_min
             self._general_user = None
             self._session = None
             self._env = ENV()
             self._pid = current_process().pid
+            self._master_session = None
 
     @property
     def session(self):
         """
         返回当前machine的session连接
         :return: SSHSession
         """
         _pid = current_process().pid
         if _pid != self._pid:  # 如果跨进程
+            self._master_session = self._session
             self.reconnect()  # 重置self._session
             self._pid = _pid
         elif not self._session:  # 如果session是空
             self.reconnect()
         self._session.env = self.env
         return self._session
 
@@ -218,21 +220,22 @@
         下载machine上的文件到本地
         :param remote_file: machine上文件路径
         :param local_file: 本地文件路径
         :return:
         """
         self.session.download(remote_file, local_file)
 
-    def trust(self, machine):
+    def trust(self, *machines):
         """
         配置互信
         :param machine: 与当前machine互信的machine实例
         :return:
         """
         cmd = "echo '+ +'> /etc/hosts.equiv"
         self.run_cmd(cmd)
-        machine.run_cmd(cmd)
+        for _machine in machines:
+            _machine.run_cmd(cmd)
 
 
 if __name__ == '__main__':
     machine = RemoteMachine('172.16.3.78', 'Big4ifmx')
     machine.download('/tmp/tape_L0', 'tape_L0')
```

## pygbase8s/onconfig.py

```diff
@@ -3,15 +3,15 @@
 # datetime: 2024/2/24 20:59
 
 """
 onconfig实例,对应实例或CM
 """
 
 from abc import ABCMeta, abstractmethod
-from multiprocessing import Manager
+from multiprocessing import Array, Lock
 
 
 class Onconfig(metaclass=ABCMeta):
     """
     onconfig文件抽象类
     """
     def __init__(self):
@@ -153,16 +153,16 @@
         :param ids: IDS，ids实例
         :param name: str，配置名称
         """
         super().__init__()
         self._ids = ids
         self._name = name
         # self._backup_file = None
-        self._backup_file = Manager().Value(str, None)
-        self._lock = Manager().Lock()
+        self._backup_file = Array('c', ''.encode())
+        self._lock = Lock()
         self._product = self.ids
 
     @property
     def ids(self):
         """
         返回配置对应的IDS实例
         :return: IDS
@@ -195,24 +195,24 @@
 
     def backup(self):
         """
         配置文件备份
         :return:
         """
         with self._lock:
-            if not self._backup_file.value:
-                self._backup_file.value = f"{self.path}.bak"
-                code, out = self.session.run_cmd(f"rm -rf {self._backup_file.value};cp -rfp {self.path} {self._backup_file.value}")
+            if self._backup_file.value == b'':
+                self._backup_file = Array('c', f"{self.path}.bak".encode())
+                code, out = self.session.run_cmd(f"rm -rf {self.path}.bak;cp -rfp {self.path} {self.path}.bak")
                 if code != 0:
                     raise Exception(f"备份{self.name}的onconfig文件失败，错误码{code}, 错误信息{out}")
 
     def recovery(self):
         """
         配置文件恢复
         :return:
         """
         with self._lock:
-            if not self._backup_file.value:
+            if self._backup_file.value == b'':
                 raise Exception(f"onconfig.{self.name}未定义备份文件，无法恢复")
-            code, out = self.session.run_cmd(f"rm -rf {self.path};cp -rfp {self._backup_file.value} {self.path}")
+            code, out = self.session.run_cmd(f"rm -rf {self.path};cp -rfp {self._backup_file.value.decode()} {self.path}")
             if code != 0:
                 raise Exception(f"恢复{self.name}的onconfig备份文件失败，错误码{code}, 错误信息{out}")
```

## pygbase8s/server.py

```diff
@@ -135,35 +135,35 @@
 
     def initialize(self):  # 初始化实例
         """
         初始化实例
         :return:
         """
         self._add_chunk_file('rootdbs')
-        code, out = self.run_cmd("oninit -ivwy", cwd=self.path)
+        code, out = self.run_cmd("oninit -ivwy", cwd=self.path, username='gbasedbt')
         if code != 0:
-            raise Exception(f"实例初始化失败，错误码{code}, 错误信息{out}")
+            raise Exception(f"实例{self.name}初始化失败，错误码{code}, 错误信息{out}")
 
     def startup(self):  # 启动实例
         """
         启动实例
         :return:
         """
-        code, out = self.run_cmd('oninit -vwy', cwd=self.path)
+        code, out = self.run_cmd('oninit -vwy', cwd=self.path, username='gbasedbt')
         if code != 0:
-            raise Exception(f"实例启动失败，错误码{code}, 错误信息{out}")
+            raise Exception(f"实例{self.name}启动失败，错误码{code}, 错误信息{out}")
 
     def shutdown(self):  # 关停实例
         """
         关停实例
         :return:
         """
-        code, out = self.run_cmd('onmode -ky;onclean -ky')
+        code, out = self.run_cmd('onmode -ky;onclean -ky', username='gbasedbt')
         if code != 0:
-            raise Exception(f"关停实例失败，错误码{code}, 错误信息{out}")
+            raise Exception(f"关停实例{self.name}失败，错误码{code}, 错误信息{out}")
 
     def release(self):  # 设置实例状态为空闲状态
         """
         释放实例(将实例归还实例池)
         :return:
         """
         with self.idle.get_lock():
```

## pygbase8s/ssh_session.py

```diff
@@ -86,15 +86,15 @@
         """
         self._env = env
 
     @property
     def channel(self):
         if not self._channel:
             self._channel = self.ssh.invoke_shell()
-            self._channel.send(f"export PS1='{self._cmd_over_flag}'\n")
+            self._channel.send(f"export PS1='{self._cmd_over_flag}'\n".encode(self.char_set))
             time.sleep(2)
             self._channel.recv(8192)
         return self._channel
 
     def _get_buffer_last_line(self, buffer) -> str:
         context: str = buffer.decode(self.char_set)
         lines = [line for line in context.splitlines() if line.strip() != '']
@@ -107,16 +107,15 @@
         :param cmd: 同 run_cmd
         :param cwd: 同 run_cmd
         :param username: 同 run_cmd
         :param timeout: 同 run_cmd
         :return: stream, 可迭代对象，exp: for text in stream: print(text,end='')
         """
         cmds_str = self._get_runtime_cmd(cmd, cwd, username, timeout)
-        self.channel.send(f'{cmds_str}\n')
-        self.channel.recv(len(cmds_str) + 2)
+        self.channel.send(f'{cmds_str}\n'.encode(self.char_set))
         while True:
             buffer = self.channel.recv(8192)
             yield buffer.decode(self.char_set)
             flag = self._get_buffer_last_line(buffer)
             if flag == self._cmd_over_flag:
                 break
 
@@ -157,14 +156,15 @@
         cmds = [f"export {k}={v}" if v else f'unset {k}' for k, v in self.env.get_variables().items()]
         exec_cmd = cmd if timeout is None else f"timeout -s SIGKILL {timeout}s {cmd}"
         cmds.append(exec_cmd)
         cmds_str = ";".join(cmds)
         if cwd:
             cmds_str = f'cd {cwd}; {cmds_str}'
         if username:
+            cmds_str = cmds_str.replace('"', '\\"')
             cmds_str = f'su - {username} --session-command "{cmds_str}"'
         return cmds_str
 
     def set_char_set(self, char_set):
         """
         设置字符集
         :param char_set: str, utf8、 gbk...
```

## Comparing `pygbase8s-1.2.0.dist-info/LICENSE` & `pygbase8s-1.3.0.dist-info/LICENSE`

 * *Files identical despite different names*

## Comparing `pygbase8s-1.2.0.dist-info/RECORD` & `pygbase8s-1.3.0.dist-info/RECORD`

 * *Files 25% similar despite different names*

```diff
@@ -1,19 +1,20 @@
-pygbase8s/__init__.py,sha256=B0uAVuX7b1Anrq6j69ayNTGm4e_Vb1bixj_Xp2ULJNo,490
-pygbase8s/cluster.py,sha256=b8--SD6E3wkwQRviQqDUJgbGZ4C8K89YqzjcF0QOUCQ,7516
-pygbase8s/cm.py,sha256=ilT3LVL8ERGCLFLJR6yMx3onK4doId0iR8zciG1XV5w,4103
+pygbase8s/__init__.py,sha256=AtilI6r2ctxOqYhtdARpMmayjX3HzCSAx5f3Y4xkQZc,499
+pygbase8s/cluster.py,sha256=NIN98XfNzwIvtuV7Nj_qmyTPekduaFgmsUyzQQangRs,8599
+pygbase8s/cm.py,sha256=QnKlSCgpWj3AlPch8wZ-xuusUIKXxIZB1hut_yvn3nc,4073
 pygbase8s/dblog.py,sha256=4Qvs72vz-I4MByzDTBK_h06Q5Hdcm9KARPNyKHkN8JY,1063
 pygbase8s/dbspace.py,sha256=P4LlqxH2oq_w63NesV6iSlDN1pCcTq41U04hKFBZDo8,6723
+pygbase8s/driver_manager.py,sha256=eAfWBD5EAqkIJ_Qgoi8qbQdUwpqXcR5kYJI6rKnMeYQ,1382
 pygbase8s/env.py,sha256=4gjzf4mzLnpOeZ4tdzrIU600H1dcScZy07l0ldcP-RU,1722
 pygbase8s/instance.py,sha256=XGIjpVBOM8RxKrmHtuFm9GVT2dxFa8_K7XClx28C4WU,2272
-pygbase8s/machine.py,sha256=85pCR9HDJpcGcgywoEWfhWHwRAxInyRG9ifnS6Dhl7E,7292
-pygbase8s/onconfig.py,sha256=td9LuSOuPX2_OfsGj7z1C89oJO2e8WpA65hknY2HBeM,6775
+pygbase8s/machine.py,sha256=dTYo9DaHFbe0iisCOgKkD55rr2O0AEjaRkTBvh1bnGo,7425
+pygbase8s/onconfig.py,sha256=2S1o0cbufuvi4q4Qzo_Em7kEYB9WHeENqLaH2GcEwi0,6776
 pygbase8s/product.py,sha256=_ey160YRmVujbKAJs1d4KbiKXblvoo8wk8_2okKZtsU,3459
-pygbase8s/server.py,sha256=qeYDld1xu6MQKoHD_ULCXiwL5ubTNuzmKGv6TeCWLNI,17651
+pygbase8s/server.py,sha256=gK9CyQ7iRLH1x1hoF-nttAxzUYjXeJ-gh8G1ob9L-H8,17747
 pygbase8s/server_pool.py,sha256=Vm2KbgqlP8t0dk2-rPjhgCQfDmuQr0RtU9YI8MY-ZHA,4587
 pygbase8s/sqlhosts.py,sha256=mzvLlz-FBmd1NTFKeSgIvoRIpOJ9wa2VQIdBjAwAspA,5730
-pygbase8s/ssh_session.py,sha256=qgQLpBqouXwwZmq5OB_MF91yyPlfTCopTvx5UFAv0XU,5580
-pygbase8s-1.2.0.dist-info/LICENSE,sha256=iT7e71c418C8Gb1Roy8MVTLW4QH9LBlP_KABIucrYLo,1086
-pygbase8s-1.2.0.dist-info/METADATA,sha256=DlTp-qDhGKFPgmQj8--udDqpRCF-fdgM0A8_GBj_PXk,1775
-pygbase8s-1.2.0.dist-info/WHEEL,sha256=OqRkF0eY5GHssMorFjlbTIq072vpHpF60fIQA6lS9xA,92
-pygbase8s-1.2.0.dist-info/top_level.txt,sha256=n0FWxtdnWKHxWNsYUyPB1PkcUhgMbx7ysAJcg-_dg1M,10
-pygbase8s-1.2.0.dist-info/RECORD,,
+pygbase8s/ssh_session.py,sha256=QIF55lXk4d9fOiCer1NEjaOapkD-2mlesdOu54ncO3c,5631
+pygbase8s-1.3.0.dist-info/LICENSE,sha256=iT7e71c418C8Gb1Roy8MVTLW4QH9LBlP_KABIucrYLo,1086
+pygbase8s-1.3.0.dist-info/METADATA,sha256=bdRCI75BASsoMZ8KdMVHPTevmcWhvhKFAhpWW5tuaR8,2615
+pygbase8s-1.3.0.dist-info/WHEEL,sha256=OqRkF0eY5GHssMorFjlbTIq072vpHpF60fIQA6lS9xA,92
+pygbase8s-1.3.0.dist-info/top_level.txt,sha256=n0FWxtdnWKHxWNsYUyPB1PkcUhgMbx7ysAJcg-_dg1M,10
+pygbase8s-1.3.0.dist-info/RECORD,,
```

